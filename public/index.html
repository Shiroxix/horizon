<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizon Command Center | Ultra Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #00f2ff; --accent: #bc13fe; --bg: #020408; 
            --card: #0d121d; --text: #f8fafc; --success: #00ff88; --danger: #ff4655;
            --border: rgba(255, 255, 255, 0.1); --glass: rgba(15, 23, 42, 0.8);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: all 0.2s ease; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; min-height: 100vh; }
        .bg-glow { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 0%, rgba(188, 19, 254, 0.15) 0%, transparent 70%); }

        /* --- TELAS DE AUTH (CORRIGIDO) --- */
        #authScreen { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(20px); }
        .auth-card { background: var(--card); border: 1px solid var(--border); padding: 40px; border-radius: 30px; width: 100%; max-width: 420px; text-align: center; display: none; }
        .auth-card.active { display: block; animation: slideUp 0.4s ease; }

        .input-cyber { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 15px; border-radius: 12px; color: #fff; margin-bottom: 15px; font-weight: 600; }
        .input-cyber:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(90deg, var(--accent), var(--primary)); color: #000; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }

        /* --- DASHBOARD E HEADER --- */
        #mainContent { display: none; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 25px 50px; border-bottom: 1px solid var(--border); background: var(--glass); position: sticky; top: 0; z-index: 100; }
        .logo { font-family: 'Rajdhani'; font-size: 2.2rem; font-weight: 700; letter-spacing: 4px; color: var(--primary); text-shadow: 0 0 15px rgba(0,242,255,0.4); }

        .user-nav { display: flex; align-items: center; gap: 15px; position: relative; }
        .user-badge { text-align: right; cursor: pointer; }
        .user-id-btn { font-size: 0.7rem; color: #64748b; background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 4px; margin-top: 4px; display: inline-block; }
        
        .adm-gear { font-size: 1.4rem; color: #64748b; cursor: pointer; display: none; }
        .adm-gear:hover { color: var(--primary); transform: rotate(45deg); }

        /* --- GRID DE MEMBROS --- */
        .container { max-width: 1400px; margin: auto; padding: 40px 20px; }
        .member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .p-card { background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid var(--border); cursor: pointer; position: relative; overflow: hidden; }
        .p-card:hover { transform: translateY(-8px); border-color: var(--primary); }
        .p-card::before { content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%; background: var(--primary); }

        /* --- MODAL DE PERFIL (ESTILO SLAA) --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal-content { max-width: 1100px; margin: 40px auto; background: var(--glass); border: 1px solid var(--border); border-radius: 40px; padding: 40px; }
        
        .brawler-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }
        .b-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .b-card b { font-family: 'Rajdhani'; font-size: 1.1rem; color: var(--primary); }

        /* --- PAINEL DE LOGS / ADM --- */
        .log-list { background: #000; border-radius: 15px; height: 250px; overflow-y: auto; padding: 15px; font-family: monospace; font-size: 0.8rem; border: 1px solid var(--border); }
        .log-item { padding: 5px 0; border-bottom: 1px solid #111; color: #aaa; }
        .log-item b { color: var(--success); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="bg-glow"></div>

    <div id="authScreen">
        <div class="auth-card active" id="loginBox">
            <h1 class="logo" style="margin-bottom: 30px;">HORIZON</h1>
            <input type="text" id="userIn" class="input-cyber" placeholder="NOME DE USU츼RIO">
            <input type="password" id="passIn" class="input-cyber" placeholder="SENHA">
            <button class="btn-main" onclick="handleAuth('login')">Acessar Painel</button>
            <p style="margin-top: 20px; font-size: 0.8rem; color: #64748b;">
                N칚o tem conta? <a href="#" onclick="switchAuth('reg')" style="color:var(--primary)">Criar agora</a>
            </p>
        </div>

        <div class="auth-card" id="regBox">
            <h1 class="logo" style="margin-bottom: 30px;">REGISTRO</h1>
            <input type="text" id="regUser" class="input-cyber" placeholder="ESCOLHA UM NOME">
            <input type="password" id="regPass" class="input-cyber" placeholder="CRIE UMA SENHA">
            <button class="btn-main" onclick="handleAuth('reg')">Finalizar Cadastro</button>
            <p style="margin-top: 20px; font-size: 0.8rem; color: #64748b;">
                J치 tem conta? <a href="#" onclick="switchAuth('login')" style="color:var(--primary)">Voltar ao Login</a>
            </p>
        </div>
    </div>

    <div id="mainContent">
        <header>
            <div class="logo">HORIZON PRO</div>
            <div class="user-nav">
                <i class="fas fa-cog adm-gear" id="admIcon" onclick="openAdm()"></i>
                <div class="user-badge" onclick="openMyProfile()">
                    <div id="navName" style="font-weight: 900; color: #fff;">-</div>
                    <div id="navID" class="user-id-btn">ID: ------</div>
                </div>
                <div id="logoutBtn" onclick="logout()" style="cursor:pointer; color:var(--danger); font-size: 0.8rem; font-weight: 900;">SAIR</div>
            </div>
        </header>

        <div class="container">
            <div class="member-grid" id="memberList">
                </div>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px;">
                <div>
                    <h1 id="m-name" style="font-size: 3rem; font-family: 'Rajdhani'; color: #ffd700;">-</h1>
                    <p id="m-tag" style="color: var(--primary); font-weight: 900; letter-spacing: 2px;">#TAG</p>
                </div>
                <button onclick="closeModal()" style="background:none; border:none; color:#fff; font-size: 2.5rem; cursor:pointer;">&times;</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                <div class="p-card"><h4>TROF칄US</h4><h2 id="m-trophies" style="font-family:'Rajdhani'; font-size: 2.5rem; color: #ffd700;">0</h2></div>
                <div class="p-card"><h4>RECORDE</h4><h2 id="m-high" style="font-family:'Rajdhani'; font-size: 2.5rem; color: var(--danger);">0</h2></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
                <div class="p-card">
                    <h3 style="margin-bottom: 20px;">VIT칍RIAS</h3>
                    <canvas id="winChart"></canvas>
                </div>
                <div class="p-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>BRAWLERS</h3>
                        <input type="text" id="bSearch" placeholder="Pesquisar..." onkeyup="filterBrawlers()" style="background: #000; border: 1px solid #333; color: #fff; padding: 5px 10px; border-radius: 8px;">
                    </div>
                    <div class="brawler-grid" id="bList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="admModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="font-family:'Rajdhani'; color: var(--accent); margin-bottom: 20px;">SYSTEM LOGS & ADMIN</h2>
            <div class="log-list" id="logItems"></div>
            <div style="margin-top: 20px;">
                <p style="font-size: 0.7rem; color: #64748b;">PROMOVER USU츼RIO (DIGITE O ID)</p>
                <input type="text" id="promoIn" class="input-cyber" placeholder="Ex: ABCD12">
                <button class="btn-main" onclick="promote()">ELEVAR STATUS</button>
            </div>
            <button class="btn-main" style="background:none; border: 1px solid #333; color:#fff; margin-top:10px;" onclick="closeAdm()">VOLTAR</button>
        </div>
    </div>

    <script>
        const MASTER_ADMIN = "shiro";
        const MASTER_PASS = "18172220";
        let currentUser = null;
        let chartInstance = null;
        let brawlersData = [];

        // 1. PERSIST칅NCIA E AUTH
        function switchAuth(mode) {
            document.getElementById('loginBox').classList.toggle('active', mode === 'login');
            document.getElementById('regBox').classList.toggle('active', mode === 'reg');
        }

        async function handleAuth(type) {
            const u = type === 'login' ? document.getElementById('userIn').value : document.getElementById('regUser').value;
            const p = type === 'login' ? document.getElementById('passIn').value : document.getElementById('regPass').value;

            if(!u || !p) return;

            let accounts = JSON.parse(localStorage.getItem('hz_accounts') || '{}');

            if(type === 'reg') {
                if(accounts[u]) return alert("Usu치rio j치 existe!");
                const id = Math.random().toString(36).substring(2, 8).toUpperCase();
                accounts[u] = { username: u, password: p, id: id, isAdm: (u.toLowerCase() === MASTER_ADMIN), tag: "#C09YYR2U" };
                localStorage.setItem('hz_accounts', JSON.stringify(accounts));
                registrarLog("Conta Criada", u);
                alert("Sucesso! ID: " + id);
                location.reload();
            } else {
                if(u.toLowerCase() === MASTER_ADMIN && p === MASTER_PASS) {
                    successLogin({ username: "Shiro", id: "MASTER-01", isAdm: true, tag: "#C09YYR2U" });
                } else if(accounts[u] && accounts[u].password === p) {
                    successLogin(accounts[u]);
                } else {
                    alert("Dados inv치lidos");
                }
            }
        }

        function successLogin(user) {
            localStorage.setItem('hz_user', JSON.stringify(user));
            registrarLog("Login Realizado", user.username);
            location.reload();
        }

        function logout() {
            registrarLog("Logout", currentUser.username);
            localStorage.removeItem('hz_user');
            location.reload();
        }

        // 2. SISTEMA DE LOGS
        function registrarLog(acao, user) {
            let logs = JSON.parse(localStorage.getItem('hz_logs') || '[]');
            logs.unshift(`[${new Date().toLocaleTimeString()}] <b>${user}</b>: ${acao}`);
            localStorage.setItem('hz_logs', JSON.stringify(logs.slice(0, 50)));
        }

        function renderLogs() {
            const logs = JSON.parse(localStorage.getItem('hz_logs') || '[]');
            document.getElementById('logItems').innerHTML = logs.map(l => `<div class="log-item">${l}</div>`).join('');
        }

        // 3. CARREGAMENTO DO DASHBOARD (API)
        window.onload = () => {
            const saved = localStorage.getItem('hz_user');
            if(saved) {
                currentUser = JSON.parse(saved);
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('navName').innerText = currentUser.username.toUpperCase();
                document.getElementById('navID').innerText = "ID: " + currentUser.id;
                if(currentUser.isAdm) document.getElementById('admIcon').style.display = 'block';
                loadClubData();
            }
        };

        async function loadClubData() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                const list = document.getElementById('memberList');
                list.innerHTML = data.club.members.sort((a,b) => b.trophies - a.trophies).map(m => `
                    <div class="p-card" onclick="openPlayer('${m.tag}')">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h3 style="font-family:'Rajdhani'; font-size:1.3rem;">${m.name}</h3>
                                <p style="font-size:0.7rem; color:#64748b;">${m.tag}</p>
                            </div>
                            <b style="color:var(--primary); font-size:1.2rem;">${m.trophies.toLocaleString()}</b>
                        </div>
                    </div>
                `).join('');
            } catch(e) { console.error("Erro API Clube"); }
        }

        // 4. PERFIL DETALHADO (ESTILO SLAA + API PLAYER)
        async function openPlayer(tag) {
            document.getElementById('profileModal').style.display = 'block';
            try {
                const res = await fetch(`/api/player/${tag.replace('#', '%23')}`);
                const p = await res.json();
                
                document.getElementById('m-name').innerText = p.name;
                document.getElementById('m-tag').innerText = p.tag;
                document.getElementById('m-trophies').innerText = p.trophies.toLocaleString();
                document.getElementById('m-high').innerText = p.highestTrophies.toLocaleString();
                
                brawlersData = p.brawlers;
                renderBrawlers(brawlersData);
                initChart(p['3vs3Victories'], p.soloVictories, p.duoVictories);
            } catch(e) { alert("Erro ao carregar jogador"); }
        }

        function initChart(v3, solo, duo) {
            const ctx = document.getElementById('winChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['3vs3', 'Solo', 'Duo'],
                    datasets: [{
                        data: [v3, solo, duo],
                        backgroundColor: ['#3b82f6', '#10b981', '#a855f7'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
            });
        }

        function renderBrawlers(list) {
            const container = document.getElementById('bList');
            container.innerHTML = list.map(b => `
                <div class="b-card">
                    <div>
                        <p style="font-size:0.8rem; font-weight:900;">${b.name.toUpperCase()}</p>
                        <span style="font-size:0.6rem; color:#64748b;">PWR ${b.power}</span>
                    </div>
                    <b>游끥 ${b.trophies}</b>
                </div>
            `).join('');
        }

        function filterBrawlers() {
            const query = document.getElementById('bSearch').value.toUpperCase();
            const filtered = brawlersData.filter(b => b.name.includes(query));
            renderBrawlers(filtered);
        }

        // 5. ADMIN FUNCTIONS
        function openAdm() { document.getElementById('admModal').style.display = 'block'; renderLogs(); }
        function closeAdm() { document.getElementById('admModal').style.display = 'none'; }
        function closeModal() { document.getElementById('profileModal').style.display = 'none'; }
        function openMyProfile() { if(currentUser) openPlayer(currentUser.tag); }

        function promote() {
            const id = document.getElementById('promoIn').value;
            let accounts = JSON.parse(localStorage.getItem('hz_accounts') || '{}');
            for(let u in accounts) {
                if(accounts[u].id === id) {
                    accounts[u].isAdm = true;
                    localStorage.setItem('hz_accounts', JSON.stringify(accounts));
                    registrarLog("Promovido a ADM", u);
                    alert("Usu치rio " + u + " promovido!");
                    return;
                }
            }
            alert("ID n칚o encontrado");
        }
    </script>
</body>
</html>
