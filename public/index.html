<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizon Ultra | Apex Command Center</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <style>
        :root {
            --primary: #00f2ff; --primary-glow: rgba(0, 242, 255, 0.4);
            --accent: #bc13fe; --accent-glow: rgba(188, 19, 254, 0.4);
            --bg: #020617; --card: rgba(15, 23, 42, 0.8);
            --text: #f8fafc; --success: #00ff88; --danger: #ff4655;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; cursor: default; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; min-height: 100vh; }
        
        .glass { background: var(--card); backdrop-filter: blur(15px); border: 1px solid var(--border); border-radius: 20px; }
        
        /* Navbar */
        nav { position: fixed; top: 0; width: 100%; z-index: 1000; padding: 20px 5%; display: flex; justify-content: space-between; align-items: center; transition: 0.4s; }
        nav.scrolled { background: rgba(2, 6, 23, 0.95); padding: 12px 5%; border-bottom: 1px solid var(--primary); }
        .logo { font-family: 'Orbitron'; font-size: 1.5rem; color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }

        /* Dashboard Layout */
        .container { max-width: 1400px; margin: 120px auto 50px; padding: 0 20px; }
        
        /* Global Stats Bar */
        .global-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-item { padding: 20px; text-align: center; border-bottom: 3px solid var(--accent); }

        /* Grid de Jogadores */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .p-card { padding: 25px; position: relative; transition: 0.4s; border: 1px solid var(--border); }
        .p-card:hover { border-color: var(--primary); transform: translateY(-8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .p-card.selected { border: 2px solid var(--success); box-shadow: 0 0 20px var(--success); }

        /* Modal Expandido */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 5000; padding: 20px; overflow-y: auto; }
        .modal-content { max-width: 1100px; margin: 20px auto; padding: 40px; border-radius: 30px; border: 1px solid var(--primary); }
        
        .tab-nav { display: flex; gap: 20px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .tab-btn { background: none; border: none; color: #64748b; padding: 10px 20px; cursor: pointer; font-weight: 700; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        /* X1 Selection Bar */
        .x1-bar { 
            position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 800px; padding: 25px; z-index: 4000;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .x1-bar.active { bottom: 30px; }

        /* IA Prediction Box */
        .ai-box { background: linear-gradient(45deg, rgba(188, 19, 254, 0.1), rgba(0, 242, 255, 0.1)); padding: 20px; border-radius: 15px; border: 1px solid var(--accent); margin-top: 20px; text-align: center; }

        /* Buttons */
        .btn-cyber { background: var(--primary); color: #000; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; cursor: pointer; }
        .btn-cyber:hover { filter: brightness(1.2); box-shadow: 0 0 15px var(--primary); }

        @media (max-width: 768px) { .global-bar { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="auth-card glass" style="padding: 50px; text-align: center; width: 400px; border: 2px solid var(--primary);">
            <h1 class="logo" style="margin-bottom: 30px; font-size: 2rem;">HORIZON <span style="color:#fff">ULTRA</span></h1>
            <input type="text" id="userInput" class="glass" style="width:100%; padding:15px; margin-bottom:15px; color:#fff; outline:none;" placeholder="OPERADOR">
            <input type="password" id="passInput" class="glass" style="width:100%; padding:15px; margin-bottom:25px; color:#fff; outline:none;" placeholder="CHAVE DE ACESSO">
            <button class="btn-cyber" style="width:100%" onclick="handleLogin()">INICIAR SISTEMA</button>
            <p id="errorMsg" style="color:var(--danger); margin-top:15px; display:none; font-size: 0.8rem;">ACESSO NEGADO: CREDENCIAIS INVÁLIDAS</p>
        </div>
    </div>

    <div id="mainApp" style="display:none;">
        <nav id="navbar">
            <div class="logo">HORIZON <span style="font-weight: 300; color: #fff;">APEX</span></div>
            <div style="display:flex; gap:20px; align-items:center;">
                <div id="userLabel" style="font-weight:900; letter-spacing: 2px; color: var(--accent);">OPERADOR</div>
                <i class="fas fa-power-off" style="color:var(--danger); cursor:pointer;" onclick="logout()"></i>
            </div>
        </nav>

        <div class="container">
            <div class="global-bar glass" data-aos="fade-down">
                <div class="stat-item">
                    <p style="font-size: 0.7rem; opacity: 0.6;">TOTAL CLUB TROPHIES</p>
                    <h2 id="totalTrophies" style="color:var(--primary)">0</h2>
                </div>
                <div class="stat-item">
                    <p style="font-size: 0.7rem; opacity: 0.6;">AVG. TROPHIES</p>
                    <h2 id="avgTrophies">0</h2>
                </div>
                <div class="stat-item">
                    <p style="font-size: 0.7rem; opacity: 0.6;">TOTAL 3V3 WINS</p>
                    <h2 id="totalWins" style="color:var(--success)">0</h2>
                </div>
                <div class="stat-item">
                    <p style="font-size: 0.7rem; opacity: 0.6;">SYNC STATUS</p>
                    <h2 style="color:var(--primary); font-size: 1rem;">ONLINE <i class="fas fa-circle-check"></i></h2>
                </div>
            </div>

            <div class="stats-grid" id="clubGrid">
                </div>
        </div>

        <div id="x1Bar" class="x1-bar glass">
            <div style="display:flex; gap:30px; align-items:center;">
                <div id="p1-display" style="color:var(--primary); font-weight:800;">JOGADOR 1</div>
                <div style="font-family:'Orbitron'; color:var(--accent); font-size:1.5rem;">VS</div>
                <div id="p2-display" style="color:var(--primary); font-weight:800;">JOGADOR 2</div>
            </div>
            <button class="btn-cyber" onclick="runX1Comparison()">ANALISAR CONFRONTO</button>
        </div>
    </div>

    <div id="masterModal" class="modal">
        <div class="modal-content glass" id="modalContent">
            </div>
    </div>

    <div id="toast" style="position:fixed; bottom:-100px; left:50%; transform:translateX(-50%); background:var(--primary); color:#000; padding:12px 30px; border-radius:50px; font-weight:900; transition:0.5s; z-index:9999;"></div>

    <script>
        const ADM_USER = "shiro";
        const ADM_PASS = "18172220";
        let clubCache = [];
        let selectedForX1 = [];
        let radarChart = null;

        // --- AUTH ---
        function handleLogin() {
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            if(u === ADM_USER && p === ADM_PASS) {
                localStorage.setItem('hz_logged', 'true');
                initDashboard();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // --- CORE ---
        async function initDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            AOS.init();
            
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                clubCache = data.club.members;
                renderDashboard();
                calculateGlobalStats();
            } catch(e) { 
                showToast("ERRO API - MODO DEMONSTRAÇÃO ATIVADO");
                // Mock para teste visual se a API falhar
                clubCache = [
                    {name: "Shiro", tag: "#1", trophies: 82000, role: "Presidente"},
                    {name: "Apex_Alpha", tag: "#2", trophies: 75000, role: "Vice"},
                    {name: "Ghost_Player", tag: "#3", trophies: 69000, role: "Membro"}
                ];
                renderDashboard();
            }
        }

        function calculateGlobalStats() {
            const total = clubCache.reduce((a, b) => a + b.trophies, 0);
            document.getElementById('totalTrophies').innerText = total.toLocaleString();
            document.getElementById('avgTrophies').innerText = Math.floor(total / clubCache.length).toLocaleString();
        }

        function renderDashboard() {
            const grid = document.getElementById('clubGrid');
            grid.innerHTML = clubCache.map((m, i) => `
                <div class="p-card glass" data-aos="fade-up" data-aos-delay="${i*50}" onclick="selectForX1('${m.tag}', '${m.name}', this)">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h3 style="font-family:'Orbitron'; font-size:1.1rem; color:var(--primary)">${m.name}</h3>
                            <p style="font-size:0.6rem; opacity:0.5;">${m.tag}</p>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:1.4rem; font-weight:900;">${m.trophies.toLocaleString()}</div>
                            <span style="font-size:0.5rem; color:var(--success)">+24H SYNC</span>
                        </div>
                    </div>
                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <span style="background:rgba(255,255,255,0.05); padding:4px 8px; border-radius:5px; font-size:0.6rem;">${m.role}</span>
                        <button class="btn-cyber" style="padding:4px 10px; font-size:0.6rem;" onclick="event.stopPropagation(); openSingleProfile('${m.tag}')">VER PERFIL</button>
                    </div>
                </div>
            `).join('');
        }

        // --- SISTEMA X1 ---
        function selectForX1(tag, name, el) {
            const idx = selectedForX1.findIndex(p => p.tag === tag);
            if(idx > -1) {
                selectedForX1.splice(idx, 1);
                el.classList.remove('selected');
            } else if(selectedForX1.length < 2) {
                selectedForX1.push({tag, name});
                el.classList.add('selected');
            }
            
            const bar = document.getElementById('x1Bar');
            if(selectedForX1.length > 0) {
                bar.classList.add('active');
                document.getElementById('p1-display').innerText = selectedForX1[0]?.name || "JOGADOR 1";
                document.getElementById('p2-display').innerText = selectedForX1[1]?.name || "JOGADOR 2";
            } else {
                bar.classList.remove('active');
            }
        }

        async function runX1Comparison() {
            if(selectedForX1.length < 2) return showToast("SELECIONE 2 JOGADORES!");
            
            showToast("IA PROCESSANDO DADOS...");
            const [p1, p2] = await Promise.all([
                fetch(`/api/player/${selectedForX1[0].tag.replace('#', '%23')}`).then(r => r.json()),
                fetch(`/api/player/${selectedForX1[1].tag.replace('#', '%23')}`).then(r => r.json())
            ]);

            const winProb = calculateWinProbability(p1, p2);

            document.getElementById('masterModal').style.display = 'block';
            document.getElementById('modalContent').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2 style="font-family:'Orbitron'; color:var(--primary)">DUELO DE DADOS: ${p1.name} VS ${p2.name}</h2>
                    <button class="btn-cyber" onclick="closeModal()">FECHAR</button>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                    <div class="glass" style="padding:20px;">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div>
                        <div class="ai-box">
                            <h4 style="color:var(--primary); margin-bottom:10px;">PREDIÇÃO DO SISTEMA</h4>
                            <div style="font-size:2rem; font-weight:900;">${p1.name} <span style="color:var(--accent)">${winProb}%</span></div>
                            <p style="font-size:0.7rem; opacity:0.6; margin-top:5px;">Baseado em vitórias 3v3 e taxa de troféus máximos.</p>
                        </div>
                        
                        <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <div class="glass" style="padding:15px; border-left:4px solid var(--primary)">
                                <h5>${p1.name}</h5>
                                <p>3v3: ${p1['3vs3Victories']}</p>
                                <p>Solo: ${p1.soloVictories}</p>
                            </div>
                            <div class="glass" style="padding:15px; border-left:4px solid var(--accent)">
                                <h5>${p2.name}</h5>
                                <p>3v3: ${p2['3vs3Victories']}</p>
                                <p>Solo: ${p2.soloVictories}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            renderRadar(p1, p2);
        }

        function calculateWinProbability(p1, p2) {
            let score1 = (p1.trophies * 0.4) + (p1['3vs3Victories'] * 0.6);
            let score2 = (p2.trophies * 0.4) + (p2['3vs3Victories'] * 0.6);
            return Math.floor((score1 / (score1 + score2)) * 100);
        }

        function renderRadar(p1, p2) {
            const ctx = document.getElementById('radarChart');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Troféus', '3v3 Wins', 'Solo Wins', 'Duo Wins', 'Max Rank'],
                    datasets: [{
                        label: p1.name,
                        data: [p1.trophies/1000, p1['3vs3Victories']/100, p1.soloVictories/10, p1.duoVictories/10, p1.highestTrophies/1000],
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.2)'
                    }, {
                        label: p2.name,
                        data: [p2.trophies/1000, p2['3vs3Victories']/100, p2.soloVictories/10, p2.duoVictories/10, p2.highestTrophies/1000],
                        borderColor: '#bc13fe',
                        backgroundColor: 'rgba(188, 19, 254, 0.2)'
                    }]
                },
                options: {
                    scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#fff' }, ticks: { display: false } } }
                }
            });
        }

        // --- UTILS ---
        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.bottom = "30px";
            setTimeout(() => t.style.bottom = "-100px", 3000);
        }
        function closeModal() { document.getElementById('masterModal').style.display = 'none'; }
        function logout() { localStorage.clear(); location.reload(); }

        window.onload = () => { if(localStorage.getItem('hz_logged')) initDashboard(); };
    </script>
</body>
</html>
